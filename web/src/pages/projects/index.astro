---
import Layout from '../../layouts/Layout.astro';
import ProjectList from '../../components/ProjectList';

const cfAuth = Astro.cookies.get('CF_Authorization')?.value;
const isLoggedIn = !!cfAuth;

// Get current user's owner_id from JWT
let currentUserId: string | null = null;
if (cfAuth) {
  try {
    const parts = cfAuth.split('.');
    if (parts.length === 3) {
      const payload = JSON.parse(atob(parts[1]));
      if (payload.email) {
        // Note: This hash should match the server-side hash
        // For display purposes, we'll just show it's the user's page
        currentUserId = 'current';
      }
    }
  } catch {}
}
---

<Layout title="My Projects">
  {isLoggedIn ? (
    <div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h1 style="font-size: 20px; font-weight: 600; color: var(--text-primary);">My Projects</h1>
        <a href="/projects/new" class="btn btn-primary" style="text-decoration: none;">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
            <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
          </svg>
          New
        </a>
      </div>
      <ProjectList client:load isLoggedIn={true} />
    </div>
  ) : (
    <div class="card" style="text-align: center; padding: 32px 12px;">
      <svg width="48" height="48" viewBox="0 0 16 16" style="fill: var(--text-muted); margin-bottom: 12px;">
        <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"/>
      </svg>
      <h2 style="font-size: 18px; color: var(--text-primary); margin-bottom: 8px;">サインインが必要です</h2>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
        プロジェクトを追加・管理するにはサインインしてください
      </p>
      <a href="/auth/login" class="btn btn-primary" style="text-decoration: none;">
        Sign in
      </a>
    </div>
  )}
</Layout>
